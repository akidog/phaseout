//= require       jquery
//= require       jquery_ujs
//= require       underscore
//= require_tree ./templates

// TODO: These route methods works, but they're ugly!
function seo_action_keys_path(key){
  var path = "<%= Phaseout::Engine.routes.url_helpers.seo_action_keys_path('PHASEOUT_ACTION_KEY') %>";
  return path.replace( 'PHASEOUT_ACTION_KEY', key.replace('#', '\%23') );
}

function seo_fields_update_path(key){
  var path = "<%= Phaseout::Engine.routes.url_helpers.seo_fields_update_path('PHASEOUT_ACTION_KEY') %>";
  return path.replace( 'PHASEOUT_ACTION_KEY', key.replace('#', '\%23') );
}

function seo_action_list_path(){
  return "<%= Phaseout::Engine.routes.url_helpers.seo_action_list_path %>";
}

function click_on_action_key_handler(action_key){
  var action_key_html_id = action_key['action_id']+'_'+action_key['id'];
  var item               = $('#'+action_key_html_id);
  var fields_form        = $('#'+action_key_html_id+' .action_key_fields');

  $('#'+action_key_html_id+' .seo_action_key_link').click((function(){
    return function(){
      fields_form.toggle();
      item.toggleClass('opened');
    };
  })());

  fields_form[0].action_key = action_key;
  fields_form.on('ajax:success', function(xhr, response_data, status){
    fields_form[0].action_key = response_data;
    alert(response_data['status']);
  });
}

function load_action_keys(key, html_id){
  $.ajax({
    url:      seo_action_keys_path(key),
    type:     'GET',
    dataType: 'json',
    success: function(data){
      var action_keys = _.sortBy(data, function(obj){ return obj['name']; });
      $('#'+html_id+' ul').append(JST['phaseout/templates/action_key_list']({ action_keys: action_keys }));
      for( var index in action_keys ){ click_on_action_key_handler(action_keys[index]); }
    }
  });
}

function click_on_action_handler(_action){
  var action = _action;
  var header = $('#'+action['id']+'.seo_action_item');
  var list   = $('#'+action['id']+' ul.action_key_list');
  $('#'+_action['id']+' .seo_action_item_link').click((function(){
    return function(){
      if( list.fecthedData ){
        list.toggle();
        list.toggleClass('opened');
        header.toggleClass('opened');
      } else {
        header.addClass('opened');
        list.addClass('opened');
        list.show();
        list.fecthedData = true;
        load_action_keys(action['key'], action['id']);
      }
    };
  })());
}

function load_actions(){
  $.ajax({
    url:      seo_action_list_path(),
    type:     'GET',
    dataType: 'json',
    success: function(data){
      var actions = _.sortBy(data, function(obj){ return obj['name']; });
      $('.seo_action_list').append(JST['phaseout/templates/action_list']({ actions: actions }));
      for( var index in actions ){ click_on_action_handler(actions[index]); }
    }
  });
}

$(document).ready(function(){ load_actions() });
