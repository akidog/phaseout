//= require       jquery
//= require       underscore
//= require_tree ./templates

// TODO: This route method works, but it's ugly!
function seo_action_keys_path(key){
  var path = "<%= Phaseout::Engine.routes.url_helpers.seo_action_keys_path('PHASEOUT_ACTION_KEY') %>";
  return path.replace( 'PHASEOUT_ACTION_KEY', key.replace('#', '\%23') );
}

function seo_action_list_path(){
  return "<%= Phaseout::Engine.routes.url_helpers.seo_action_list_path %>";
}

function load_action_keys(key, html_id){
  $.ajax({
    url:      seo_action_keys_path(key),
    type:     'GET',
    dataType: 'json',
    success: function(json){
      var action_keys = _.sortBy(json, function(obj){ return obj['name']; });
      $('#'+html_id+' ul').append(JST['phaseout/templates/action_key_list']({ action_keys: action_keys }));
    }
  });
}

function click_on_action_handler(_action){
  var action = _action;
  var list   = $('#'+action['id']+' ul.action_key_list');
  $('#'+_action['id']+' .seo_action_item_link').click((function(){
    return function(){
      if( list.fecthedData ){
        list.toggle();
      } else {
        list.fecthedData = true;
        load_action_keys(action['key'], action['id']);
      }
    };
  })(_action));
}

function load_actions(){
  $.ajax({
    url:      seo_action_list_path(),
    type:     'GET',
    dataType: 'json',
    success: function(json){
      var actions = _.sortBy(json, function(obj){ return obj['name']; });
      $('.seo_action_list').append(JST['phaseout/templates/action_list']({ actions: actions }));
      for( var index in actions ){ click_on_action_handler(actions[index]); }
    }
  });
}

$(document).ready(function(){ load_actions() });
